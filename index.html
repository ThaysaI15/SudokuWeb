<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sudoku com Limite de Erros</title>
<style>
body { font-family: Arial, sans-serif; background: #f7f8fa; text-align: center; margin:0; padding:0;}
h1 { margin-top: 20px; color: #0077cc; }
#sudoku-container { display: grid; grid-template-columns: repeat(9,50px); grid-template-rows: repeat(9,50px); justify-content:center; margin:20px auto; border:3px solid #000;}
.cell { width:50px; height:50px; text-align:center; font-size:20px; border:1px solid #ccc; background:#fff; position:relative; cursor:pointer; display:flex; align-items:center; justify-content:center; user-select:none;}
.cell.top-border { border-top:3px solid #000; }
.cell.left-border { border-left:3px solid #000; }
.cell.right-border { border-right:3px solid #000; }
.cell.bottom-border { border-bottom:3px solid #000; }

.highlight-line { background: #e8f4ff !important; }
.highlight-block { background: #f0f0f0 !important; }
.highlight-same-number { background: #cce5ff !important; }

.pencil { font-size:10px; color:#555; position:absolute; top:2px; left:2px; width:46px; height:46px; display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr);}
.pencil span { display:flex; align-items:center; justify-content:center; }

.controls { margin: 15px; }
button { padding:8px 12px; margin:5px; border:none; background:#0077cc; color:white; border-radius:5px; cursor:pointer; font-size:14px;}
button.active { background:#28a745 !important; }

#current-mode { margin-left:10px; font-weight:bold; }
#message { margin-top:10px; font-weight:bold; }
#error-counter { margin-top:5px; font-weight:bold; color:#c82333;}
.hidden { display:none; }
</style>
</head>
<body>
<h1>üß© Sudoku com Limite de Erros</h1>
<div id="sudoku-container"></div>

<div class="controls">
  <button id="new">üîÑ Novo Sudoku</button>
  <button id="pencil-btn">‚úèÔ∏è L√°pis</button>
  <button id="eraser-btn">üßΩ Borracha</button>
  <button id="redo-btn">‚Ü©Ô∏è Refazer</button>
  <span id="current-mode">Modo: Normal</span>
</div>

<p id="message"></p>
<p id="error-counter">Erros: 0 / 3</p>
<div id="end-options" class="hidden">
  <button id="retry-btn">üîÑ Tentar de Novo</button>
  <button id="another-btn">üé≤ Novo Jogo</button>
</div>

<script>
const sudokuContainer = document.getElementById("sudoku-container");
const message = document.getElementById("message");
const modeDisplay = document.getElementById("current-mode");
const pencilBtn = document.getElementById("pencil-btn");
const eraserBtn = document.getElementById("eraser-btn");
const errorCounterDisplay = document.getElementById("error-counter");
const endOptions = document.getElementById("end-options");
const retryBtn = document.getElementById("retry-btn");
const anotherBtn = document.getElementById("another-btn");

let puzzle=[], solution=[];
let mode = "normal";
let history = [];
let selectedCell = null;
let errors = 0;
let gameOver = false;

// ---------------------------
// Sudoku Generator
// ---------------------------
function generateSolvedSudoku() {
  const grid = Array(9).fill(null).map(()=>Array(9).fill(0));
  function isSafe(row,col,num){
    for(let x=0;x<9;x++){
      if(grid[row][x]===num||grid[x][col]===num) return false;
    }
    const startRow=row-(row%3), startCol=col-(col%3);
    for(let r=0;r<3;r++) for(let c=0;c<3;c++)
      if(grid[startRow+r][startCol+c]===num) return false;
    return true;
  }
  function fillGrid(row=0,col=0){
    if(row===9) return true;
    const nextRow=col===8?row+1:row;
    const nextCol=col===8?0:col+1;
    const nums=[1,2,3,4,5,6,7,8,9].sort(()=>Math.random()-0.5);
    for(let num of nums){
      if(isSafe(row,col,num)){
        grid[row][col]=num;
        if(fillGrid(nextRow,nextCol)) return true;
        grid[row][col]=0;
      }
    }
    return false;
  }
  fillGrid();
  return grid;
}

function removeNumbers(grid,difficulty=0.55){
  const newGrid = grid.map(r=>[...r]);
  for(let row=0;row<9;row++) for(let col=0;col<9;col++)
    if(Math.random()<difficulty) newGrid[row][col]=0;
  return newGrid;
}

// ---------------------------
// Create Board
// ---------------------------
function createBoard(){
  sudokuContainer.innerHTML="";
  for(let row=0;row<9;row++){
    for(let col=0;col<9;col++){
      const cell=document.createElement("div");
      cell.classList.add("cell");
      cell.dataset.row=row;
      cell.dataset.col=col;
      cell.dataset.value = puzzle[row][col] || "";
      cell.dataset.pencil = "";
      cell.dataset.counted="false";
      if(row%3===0) cell.classList.add("top-border");
      if(col%3===0) cell.classList.add("left-border");
      if(col===8) cell.classList.add("right-border");
      if(row===8) cell.classList.add("bottom-border");

      if(puzzle[row][col]!==0){
        cell.textContent=puzzle[row][col];
        cell.dataset.fixed="true";
        cell.style.background="#ddd";
      }

      const pencilDiv=document.createElement("div");
      pencilDiv.classList.add("pencil");
      cell.appendChild(pencilDiv);

      cell.addEventListener("click",()=>selectCell(cell));
      sudokuContainer.appendChild(cell);
    }
  }
}

// ---------------------------
// Highlight
// ---------------------------
function selectCell(cell){
  if(gameOver) return;
  selectedCell = cell;
  const allCells=document.querySelectorAll(".cell");
  allCells.forEach(c=>c.classList.remove("highlight-line","highlight-block","highlight-same-number"));
  const row=parseInt(cell.dataset.row);
  const col=parseInt(cell.dataset.col);
  const val=cell.dataset.value;
  allCells.forEach(c=>{
    const r=parseInt(c.dataset.row);
    const co=parseInt(c.dataset.col);
    if(r===row||co===col) c.classList.add("highlight-line");
    if(Math.floor(r/3)===Math.floor(row/3)&&Math.floor(co/3)===Math.floor(col/3))
      c.classList.add("highlight-block");
    if(val!==""&&c.dataset.value===val) c.classList.add("highlight-same-number");
  });
}

// ---------------------------
// Input Handling
// ---------------------------
document.addEventListener("keydown", e=>{
  if(!selectedCell || selectedCell.dataset.fixed || gameOver) return;
  const key = e.key;
  if(/\d/.test(key) && key!=="0"){
    handleInput(key);
  } else if(key==="Backspace" || key==="Delete"){
    handleInput("");
  }
});

function handleInput(value){
  history.push({cell:selectedCell, prevValue:selectedCell.dataset.value});
  if(mode==="normal"){
    selectedCell.dataset.value=value;
    selectedCell.textContent=value;
    selectedCell.dataset.pencil="";
    updatePencil(selectedCell);
    checkCell(selectedCell);
  } else if(mode==="pencil"){
    let pencilSet = new Set(selectedCell.dataset.pencil.split("").filter(n=>n));
    if(value==="") return;
    if(pencilSet.has(value)) pencilSet.delete(value);
    else pencilSet.add(value);
    selectedCell.dataset.pencil=[...pencilSet].sort().join("");
    updatePencil(selectedCell);
  } else if(mode==="eraser"){
    selectedCell.dataset.value="";
    selectedCell.textContent="";
    selectedCell.dataset.pencil="";
    selectedCell.dataset.counted="false";
    selectedCell.style.background="#fff";
    updatePencil(selectedCell);
  }
  selectCell(selectedCell);
}

function updatePencil(cell){
  const pencilDiv=cell.querySelector(".pencil");
  pencilDiv.innerHTML="";
  for(let n=1;n<=9;n++){
    if(cell.dataset.pencil.includes(n.toString())){
      const span=document.createElement("span");
      span.textContent=n;
      pencilDiv.appendChild(span);
    }
  }
}

// ---------------------------
// Automatic Check
// ---------------------------
function checkCell(cell){
  const val=parseInt(cell.dataset.value);
  const row=parseInt(cell.dataset.row);
  const col=parseInt(cell.dataset.col);

  if(!val){ 
    cell.style.background="#fff"; 
    cell.dataset.counted="false";
    return; 
  }

  if(val !== solution[row][col]){
    // Erro
    cell.style.background="#f8d7da"; 
    if(cell.dataset.counted==="false"){
      errors++;
      cell.dataset.counted="true";
      errorCounterDisplay.textContent=`Erros: ${errors} / 3`;
      if(errors>=3){
        endGame(false);
        return;
      }
    }
  } else {
    // Correto
    cell.style.background="#d4edda";
    cell.dataset.counted="false";
  }

  checkWin();
}

function checkWin(){
  const cells = document.querySelectorAll(".cell");
  let complete = true;
  for(const cell of cells){
    const val = parseInt(cell.dataset.value);
    if(!val || val!==solution[cell.dataset.row][cell.dataset.col]){
      complete = false;
      break;
    }
  }
  if(complete){ endGame(true); }
}

function endGame(win){
  gameOver = true;
  document.querySelectorAll(".cell").forEach(c=>c.style.pointerEvents="none");
  endOptions.classList.remove("hidden");
  if(win) message.textContent="üéâ Parab√©ns! Voc√™ completou o Sudoku!";
  else message.textContent="üí• Voc√™ perdeu! Atingiu 3 erros.";
}

// ---------------------------
// Controls
// ---------------------------
function newGame(){
  solution = generateSolvedSudoku();
  puzzle = removeNumbers(solution,0.55);
  message.textContent="";
  history=[];
  selectedCell=null;
  errors=0;
  gameOver=false;
  errorCounterDisplay.textContent="Erros: 0 / 3";
  mode="normal";
  resetButtons();
  endOptions.classList.add("hidden");
  createBoard();
}

function resetButtons(){
  [pencilBtn, eraserBtn].forEach(btn=>btn.classList.remove("active"));
  modeDisplay.textContent="Modo: Normal";
  mode="normal";
}

// ---------------------------
// Mode Buttons
// ---------------------------
pencilBtn.addEventListener("click",()=>{
  if(mode==="pencil"){ resetButtons(); }
  else {
    mode="pencil";
    pencilBtn.classList.add("active");
    eraserBtn.classList.remove("active");
    modeDisplay.textContent="Modo: L√°pis";
  }
});

eraserBtn.addEventListener("click",()=>{
  if(mode==="eraser"){ resetButtons(); }
  else {
    mode="eraser";
    eraserBtn.classList.add("active");
    pencilBtn.classList.remove("active");
    modeDisplay.textContent="Modo: Borracha";
  }
});

document.getElementById("new").addEventListener("click",()=>{ newGame(); });
document.getElementById("redo-btn").addEventListener("click",()=>{
  if(history.length===0) return;
  const last=history.pop();
  last.cell.dataset.value=last.prevValue;
  last.cell.textContent=last.prevValue;
  updatePencil(last.cell);
  checkCell(last.cell);
});
retryBtn.addEventListener("click",()=>{
  errors=0;
  gameOver=false;
  errorCounterDisplay.textContent="Erros: 0 / 3";
  document.querySelectorAll(".cell").forEach(c=>{
    if(!c.dataset.fixed){
      c.dataset.value="";
      c.textContent="";
      c.dataset.pencil="";
      c.dataset.counted="false";
      c.style.background="#fff";
      c.style.pointerEvents="auto";
    }
  });
  endOptions.classList.add("hidden");
  message.textContent="";
});
anotherBtn.addEventListener("click",()=>{ newGame(); });

// Inicia
newGame();
</script>

</body>
</html>
